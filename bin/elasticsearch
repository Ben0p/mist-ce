#!/bin/sh

USAGE="Usage: $0 [-h] [-f]

Apply Elasticsearch Templates idempotently once the service is responsive

Options:
    -h      Show this help message
    -f      Force-update templates
"

while getopts ":hf" opt; do
    case "$opt" in
        h)
            echo "$USAGE"
            exit
            ;;
        f)
            FORCE=1
            ;;
        \?)
            echo >&2
            echo "Invalid option: -$OPTARG" >&2
            echo >&2
            echo "$USAGE" >&2
            exit 1
    esac
done

set -ex

while ! nc -z elasticsearch 9200; do
    sleep 1
done

if [ -z $FORCE ]; then
    python /elasticsearch/scripts/add_templates.py
else
    python /elasticsearch/scripts/add_templates.py -f
fi
