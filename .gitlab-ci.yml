stages:
  - test
  - build

.docker_build_template: &docker_build_template
  stage: build
  tags:
    - builder
  dependencies: []

tests_base_manual_build:
  <<: *docker_build_template
  when: manual
  script:
    - docker build --rm -t gcr.io/mist-ops/tests_base:$CI_COMMIT_REF_SLUG .
    - docker push gcr.io/mist-ops/tests_base:$CI_COMMIT_REF_SLUG

run_mayday_test:
  image: gcr.io/mist-ops/tests_base
  stage: test
  tags:
    - shm
  only:
    - triggers
  before_script:
    - echo $MAYDAY_SETTINGS | base64 -d > test_settings.py
    - export DISPLAY=:1.0
    - pip install -e .
  script:
    - python prepare_env.py -k --tags=graph,ssh,alert,celery,google_sso_signin,github_sso_signin,confirm_alert_email misttests/gui/core/mayday/features
  artifacts:
    paths:
      - js_console.log
      - error*
      - test.mp4
    expire_in: 7 days
    when: always
