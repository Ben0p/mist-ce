stages:
    - test
    - build

run_mayday_test:
    image: gcr.io/mist-ops/fulltest2:2.10
    stage: test
    only:
        - triggers
    before_script:
        # export all the necessary env variables
        - export PATH=/builds/mistio/tests/gitlab/:$PATH
        - export DISPLAY=:1.0
        - Xvfb :1 -screen 0 1024x768x24 > /dev/null 2>&1 &
        # symlink tests to simulate the paths used for mist.core
        - rm -rf /builds/mistio/tests
        - mv /builds/mistio/mist.tests /builds/mistio/tests
    script:
        - cd /builds/mistio
#        - /core.env/bin/behave -k -tags=google_sso_signin tests/gui/core/mayday/features
#        - /core.env/bin/ipython /mist.core/tests/prepare_env.py -- --register_user_before_feature false -k --tags=alert,graph,ssh,celery,google_sso_signin,github_sso_signin mist.tests/gui/core/mayday/features
        - /core.env/bin/ipython /builds/mistio/tests/prepare_env.py -- -k --tags=google_sso_signin tests/gui/core/mayday/features
#        - /builds/mistio/mist.tests/gitlab/chromedriver


raise_mayday:
    image: gcr.io/mist-ops/fulltest2:2.10
    stage: build
    when: on_failure
    script:
        - /core.env/bin/ipython check_last_build.py
