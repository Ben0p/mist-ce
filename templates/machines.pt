<div id="actions-list">
    <ul class="actions" >
        <li id="create" class="enabled"><a rel="#wizard">Create</a></li>
        <li id="start"><a>Start</a></li>
        <li id="reboot"><a>Reboot</a></li>
        <li id="destroy"><a>Destroy</a></li>
        <li id="shell"><a>Console</a></li>
    </ul>
</div>
<ul id="button-header">
    <li class="head-button visible-in-list select-widget">
        <span class="check"></span>
        <ul class="sub-menu rounded-right-bottom">
            <li id="button-select-all">All</li>
            <li id="button-deselect-all">None</li>
        </ul>
    </li>

    <li class="head-button backend-button backend-template"></li>
    <li id="button-back" class="head-button visible-in-details">Back</li>
</ul>
<div id="machines-list">
    <!--div class="node node-header">
        <span class="name">Name</span>
        <span class="header-state">State</span>
        <span class="ip">IP</span>
    </div-->
    <div class="node-template">
        <a><span class="select" id="chk-node.id">
            <span class="check"></span>
        </span></a>
        <span class="name"></span>
        <span class="state"></span>
        <span class="ip"></span>
    </div>
</div>

<div id="machine-details">
    stuf
</div>

<!-- the form -->
<form action="#">
    <div class="overlay" id="wizard">
        <h2>
            <strong>Create a new Virtual Machine</strong>
        </h2>
        <ul>
            <!-- instance name -->
            <li class="required">
                <label>
                    <strong>1.</strong> Instance name <em>e.g. My mail server.</em>
                    <br />
                    <input type="text" class="text" name="instance_name" />
                </label>
            </li>
            <!-- image -->
            <li class="required">
                <label>
                    <strong>2.</strong> Select an image <br />
                    <select name="image">
                        <option value="">-- please select --</option>
                        <!--option tal:repeat="image images" tal:attributes="id image.id" tal:content="image.name">Ubuntu 10.04 x86_64 server</option-->
                    </select>
                </label>
            </li>
            <!-- size -->
            <li class="required">
                <label>
                    <strong>3.</strong> Select VM size<br />
                    <select name="size">
                        <option value="">-- please select --</option>
                        <!--option tal:repeat="size sizes" tal:attributes="id size.id" tal:content="size.name">small</option-->
                    </select>
                </label>
            </li>
            <li class="clearfix">
                 <button type="button" class="start right">Start VM</button>
            </li>

        </ul>
    </div>
</form>

<script>
$(function() {
    $(".enabled#create a[rel]").overlay({
            top: 'center',
            mask: {
                color: '#000',
                opacity: '.4'
            },
            effect: 'apple'
        });
    });

$(function() {
    // validation logic is done inside the onBeforeSeek callback
    $('.start').click(function() {
        inputs = $('#wizard').find(".required :input").removeClass("error"),
        empty = inputs.filter(function() {
           return $(this).val().replace(/\s*/g, '') == '';
        });
         // if there are empty fields, then
        if (empty.length) {
            // add a CSS class name "error" for empty & required fields
            empty.addClass("error");
            // cancel seeking of the scrollable by returning false
            return false;
        } else {    // everything is good
            alert('ok');
        }
    });

    $('.cancel').click(function() {
        $(".enabled#create a[rel]").overlay().close();
    });

});

// Clicking on node brings up the details pane
$('.node').live('click', function() {
    $('#machines-list').fadeOut(200, function() {
        $('#machine-details').fadeIn(200, update_actions);
    });
    $('.head-button:not(.visible-in-details)').fadeOut(200, function() {
        $('.visible-in-details').fadeIn(200);
    });
    return false;
});

// Clicking on back button brings up the list again
$('#button-back').click(function() {
    $('#machine-details').fadeOut(200, function() {
        $('#machines-list').fadeIn(200, update_actions);
    });
    $('.head-button:not(.visible-in-list)').fadeOut(200, function() {
        $('.visible-in-list').fadeIn(200);

    });
    return false;
});

$('#button-select-all').click(function() {
    $('.node').addClass('selected');
    $('#button-header .check').parent().addClass('selected');
    $('#button-header .check').parent().removeClass('partial');
    update_actions();
    return false;
});

$('#button-deselect-all').click(function() {
    $('.node').removeClass('selected');
    $('#button-header .check').parent().removeClass('selected');
    $('#button-header .check').parent().removeClass('partial');
    update_actions();
    return false;
});

$('.node a').live('click', function() {
    $(this).parent().toggleClass('selected');
    if ($('.node.selected .check').length == $('.node .check').length){
        $('#button-header .check').parent().addClass('selected');
        $('#button-header .check').parent().removeClass('partial');
    } else if ($('.node.selected .check').length == 0) {
        $('#button-header .check').parent().removeClass('selected');
        $('#button-header .check').parent().removeClass('partial');
    } else {
        $('#button-header .check').parent().addClass('partial');
        $('#button-header .check').parent().removeClass('selected');
    }
    update_actions();
    return false;
});

$('#button-header .check').click(function() {
    if ($('.node.selected .check').length == $('.node .check').length) {
        $('.node').removeClass('selected');
        $(this).parent().removeClass('selected');
        $(this).parent().removeClass('partial');

    } else {
        $(this).parent().addClass('selected');
        $(this).parent().removeClass('partial');
        $('.node').addClass('selected');
    }
    update_actions();
    return false;
});

function update_actions() {
    if ($('#machines-list:visible').length == 0){
        $('#actions-list #create').removeClass('enabled');
        $('#actions-list #destroy').addClass('enabled');
    } else if ($('.node.selected .check').length == 0){
        $('#actions-list #create').addClass('enabled');
        $('#actions-list #destroy').removeClass('enabled');
    } else {
        $('#actions-list #create').removeClass('enabled');
        $('#actions-list #destroy').addClass('enabled');
    }
}

$("ul#button-header li").click(function() { //When trigger is clicked...

    var $this = $(this);
    $this.addClass('active');
    //Following events are applied to the subnav itself (moving subnav up and down)
    $this.parent().find("ul.sub-menu").slideDown(200).show(); //Drop down the subnav on click

    $this.parent().hover(function() {
    }, function(){
        $this.parent().find("ul.sub-menu").slideUp(200, function(){ $this.removeClass('active')});
    });

    //Following events are applied to the trigger (Hover events for the trigger)
}).hover(function() {
    $this.addClass('active'); //On hover over, add class "subhover"
});


$(document).ready(function(){

    $('#machine-details').hide();
    $('.head-button:not(.visible-in-list)').hide();

    $("ul.sub-menu").parent().append("<span></span>"); //Only shows drop down trigger when js is enabled (Adds empty span tag after ul.subnav*)

    backends.forEach(function(b, i){
        button =  $('.backend-template').clone();
        button.addClass('visible-in-list');
        button.appendTo('#button-header');
        button.text(b.title);
        button.fadeIn(200);
        button.removeClass('backend-template');
        b.new_action(['list_machines']);
    });
});


function update_machines_view(backend){
    backend.machines.forEach(function(machine, index){
        node = $('.node-template').clone();
        node.removeClass('node-template');
        node.addClass('node');
        node.appendTo('#machines-list');
        node.find('.name').text(machine.name);
        node.find('.ip').text(machine.public_ips[0]);
        node.find('.select')[0].id = 'chk-' + machine.id;
        node[0].id = machine.id;
        node.fadeIn(200);
    });
}

</script>
